/**
  ***************************************************************************************************************************************
  * @file     bat.c
  * @owner    SimonBat
  * @version  v0.0.1
  * @date     2021.06.08
  * @update   2021.06.08
  * @brief    sentinel v1.0
  ***************************************************************************************************************************************
  * @attention
  *
  * (Where to use)
  *
  ***************************************************************************************************************************************
  */

#include "bat.h"
#include "led.h"

static bat_ts H_BAT;

/**
  ***************************************************************************************************************************************
  * @brief  Battery fuel gauge initialization
  * @param  None
  * @retval None
  ***************************************************************************************************************************************
  */
void BAT_Init(void)
{
	if(0 != GasGauge_Initialization(&H_BAT.config, &H_BAT.data)){BSP_Error_Handler();}
	else
	{
		H_BAT.offTmo = 5000U;
		H_BAT.initFlag = 1U;
	}
}

/**
  ***************************************************************************************************************************************
  * @brief  Battery fuel gauge initialization
  * @param  None
  * @retval None
  ***************************************************************************************************************************************
  */
void BAT_Handler(void)
{
	if((H_BAT.initFlag) && (!H_BAT.updateTmo))
	{
		H_BAT.updateTmo = BAT_UPDATE_TMO;
		GasGauge_Task(&H_BAT.config, &H_BAT.data);
		if((0 == H_BAT.data.SOC) && (!H_BAT.offTmo)){BSP_System_off();};
	}
}

/**
  ***************************************************************************************************************************************
  * @brief  Battery fuel gauge get SOC value
  * @param  None
  * @retval SOC (uint8_t)
  ***************************************************************************************************************************************
  */
uint8_t BAT_Get_SOC(void)
{
	if(H_BAT.initFlag){return (H_BAT.data.SOC + 5U) / 10U;}
	else{return 0U;}
}

/**
  ***************************************************************************************************************************************
  * @brief  Battery handle update timers
  * @param  None
  * @retval None
  ***************************************************************************************************************************************
  */
void BAT_Update_TMO(void)
{
	if(H_BAT.updateTmo){H_BAT.updateTmo--;}
	if(H_BAT.offTmo){H_BAT.offTmo--;}
}
